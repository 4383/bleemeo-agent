#!/bin/bash

set -e

cd work
docker run --rm -v $(pwd):/srv/workspace -w /srv/workspace \
    bleemeo/pbuilder dpkg-source -b bleemeo-agent-*

docker run --privileged=true --rm \
    -v /srv/pbuilder:/srv/pbuilder \
    -v $(pwd):/srv/workspace -w /srv/workspace \
    bleemeo/pbuilder pbuilder \
        build \
        --basetgz /srv/pbuilder/ubuntu-trusty-amd64-base.tgz \
        --buildresult /srv/workspace/result \
        --debbuildopts -sa \
        bleemeo-agent_*.dsc

docker run --rm \
    -v $(pwd):/srv/workspace -w /srv/workspace \
    centos sh -ec '
yum install -y rpm-build
mkdir -p /root/rpmbuild/SOURCES/ /root/rpmbuild/SPECS/
cp -v bleemeo-agent_*.tar /root/rpmbuild/SOURCES/
cp -v bleemeo-agent-*/packaging/centos/bleemeo-agent.spec /root/rpmbuild/SPECS/
rpmbuild -bs /root/rpmbuild/SPECS/bleemeo-agent.spec
cp /root/rpmbuild/SRPMS/bleemeo-agent-*.src.rpm .'

docker run --rm --privileged \
    -v $(pwd):/srv/workspace -w /srv/workspace \
    centos sh -ec '
yum install -y mock
adduser -g mock mock
su mock -c "/usr/bin/mock --resultdir ./result bleemeo-agent-*.src.rpm"'
