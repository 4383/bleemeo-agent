#!/bin/bash

set -e

COMMIT_HASH=$(git rev-parse --short master)
VERSION=0.$(TZ=UTC date +%Y%m%d.%H%M%S)

mkdir work
mkdir work/result

git archive --format=tar --output=work/bleemeo-agent_${VERSION}.tar --prefix=bleemeo-agent-${VERSION}/ master

cd work
tar xvf bleemeo-agent_${VERSION}.tar

cd bleemeo-agent-${VERSION}
rm -f debian/changelog
DEBEMAIL=jenkins@bleemeo.com DEBFULLNAME="Bleemeo Packaging Team" dch --create \
    --package bleemeo-agent \
    --newversion ${VERSION} \
    --distribution unstable \
    --urgency low \
    "Build package based on ${COMMIT_HASH} commit"
